# MyWineMemory 総合技術仕様書 v5.0

## 1. プロジェクト概要

### 1.1 基本情報
**サイト名**: MyWineMemory  
**URL**: my-wine-memory.himazi.com  
**コンセプト**: 飲んだワインを記録し、クイズで学習できるWebアプリケーション  
**デザイン**: ダークテーマ（バー雰囲気の落ち着いた大人デザイン）

### 1.2 技術スタック
- **フロントエンド**: React 18 + TypeScript + Vite
- **バックエンド**: Firebase (Firestore, Authentication, Storage, Hosting, Messaging)
- **状態管理**: React Context API（認証・エラー）
- **PWA**: Vite PWA plugin + Workbox
- **決済**: Stripe（実装予定）
- **外部API**: OpenRouter/Groq（LLM連携）
- **グラフ**: Chart.js + react-chartjs-2
- **エラー追跡**: Sentry（準備済み）

## 2. アーキテクチャ概要

### 2.1 設計パターン
- **サービスレイヤー**: シングルトンパターンによるFirebase抽象化
- **Context API**: 認証状態・エラーの2つのコンテキスト
- **カスタムフック**: 非同期操作・エラーハンドリング
- **エラーバウンダリー**: 中央集権的エラーハンドリング

### 2.2 バンドル最適化戦略
```typescript
// チャンク分割戦略（vite.config.ts）
{
  'vendor-react': React関連ライブラリ,
  'vendor-firebase': Firebase SDK,
  'vendor-charts': Chart.js関連,
  'page-wine-recording': SelectWine + AddTastingRecord,
  'page-wine-viewing': Records + WineDetail,
  'page-quiz': Quiz + QuizGame,
  'services-wine': ワイン関連サービス,
  'services-core': firebase.ts + 認証関連
}
```

## 3. データ構造（過渡期仕様）

### 3.1 TastingRecord Collection (`tasting_records`)
```typescript
interface TastingRecord {
  id: string;
  userId: string;
  wineId: string;           // WineMaster参照（将来用）
  
  // 埋め込みワイン基本情報（現行仕様）
  wineName: string;         // 必須
  producer: string;         // 必須（生産者・ワイナリー名）
  country: string;          // 必須（選択式）
  region: string;           // 必須（country連動選択式）
  vintage?: number;
  grapeVarieties?: string[];
  wineType?: 'red' | 'white' | 'rose' | 'sparkling' | 'dessert' | 'fortified';
  alcoholContent?: number;
  soilInfo?: string;
  climate?: string;         // wineType連動選択式
  wineHistory?: string;
  winemaker?: string;       // 醸造家名（producerと区別）
  price?: number;           // プライベートな情報なので、公開設定になっていない場合は非公開
  purchaseLocation?: string;// プライベートな情報なので、公開設定になっていない場合は非公開
  links?: string[];         // 参考リンク配列（最大5個）
  
  // 必須テイスティング情報
  overallRating: number;    // 0.0-10.0
  tastingDate: Date | string; //デフォルトは当日
  recordMode: 'quick' | 'detailed';
  
  // 付加情報
  notes?: string;
  images?: string[];        // 最大5枚（無料：1枚、有料：4枚）
  
  // 詳細分析（detailed mode限定）
  detailedAnalysis?: {
    appearance?: {
      color: string;
      intensity: number;      // 1-5
      clarity: string;
      viscosity: string;
    };
    aroma?: {
      firstImpression: { intensity: number; notes: string };
      afterSwirling: { intensity: number; notes: string };
      categories: {
        fruity: number;       // 0-4スケール
        floral: number;
        spicy: number;
        herbal: number;
        earthy: number;
        woody: number;
        other: number;
      };
      specificAromas: string[];
    };
    taste?: {
      attack: { intensity: number; notes: string };
      development: { complexity: number; notes: string };
      finish: { length: number; seconds?: number; notes: string };
    };
    structure?: {
      acidity: { intensity: number; type?: string[] };
      tannins: { intensity: number; texture?: string[] };
      sweetness: number;      // 1-5
      body: number;           // 1-5
    };
    timeBasedNotes?: {
      time: string;
      temperature?: number;
      notes: string;
    }[];
  };
  
  // 環境・コンテキスト
  environment?: {
    temperature?: number;
    decanted?: boolean;
    glassType?: string;       // wineType連動選択式（画像付き）
    lighting?: string;
    mood?: string;
    companions?: string;
    occasion?: string;
  };
  
  // 過去記録引用情報
  citations?: {
    sourceRecordId: string;   // 引用元記録ID
    citedFields: string[];    // 引用したフィールド名
    citedAt: Date;           // 引用日時
    partialText?: string;    // 部分引用の場合のテキスト
  }[];
  
  // メタデータ
  isPublic: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

### 3.2 選択式フィールドの定数定義
```typescript
// 国別地域マッピング
const WINE_REGIONS: Record<string, string[]> = {
  'フランス': ['ボルドー', 'ブルゴーニュ', 'シャンパーニュ', 'ローヌ', 'ロワール', 'アルザス', 'ラングドック'],
  'イタリア': ['トスカーナ', 'ピエモンテ', 'ヴェネト', 'シチリア', 'プーリア', 'マルケ', 'ウンブリア'],
  'スペイン': ['リオハ', 'リベラ・デル・ドゥエロ', 'プリオラト', 'リアス・バイシャス', 'ヘレス'],
  'ドイツ': ['モーゼル', 'ラインガウ', 'ファルツ', 'バーデン', 'ヴュルテンベルク'],
  'アメリカ': ['ナパ・ヴァレー', 'ソノマ', 'パソ・ロブレス', 'オレゴン', 'ワシントン'],
  'オーストラリア': ['バロッサ・ヴァレー', 'ハンター・ヴァレー', 'マーガレット・リバー', 'クレア・ヴァレー'],
  'その他': ['その他の地域']
};

// ワインタイプ別気候選択肢
const WINE_CLIMATES: Record<WineType, string[]> = {
  red: ['大陸性気候', '地中海性気候', '海洋性気候', '温帯気候', '冷涼気候'],
  white: ['冷涼気候', '温帯気候', '大陸性気候', '地中海性気候', '海洋性気候'],
  rose: ['地中海性気候', '温帯気候', '海洋性気候', '大陸性気候'],
  sparkling: ['冷涼気候', '大陸性気候', '海洋性気候', '温帯気候'],
  dessert: ['地中海性気候', '温帯気候', '大陸性気候', '亜熱帯気候'],
  fortified: ['地中海性気候', '温帯気候', '海洋性気候', '大陸性気候']
};
```

### 3.3 グラスタイプ定義
```typescript
interface GlassType {
  id: string;
  name: string;
  description: string;
  imageUrl: string;
  characteristics: string[];
  suitableFor: WineType[];
  volume: number;
  manufacturer?: string;
}

const GLASS_TYPES: GlassType[] = [
  {
    id: 'bordeaux',
    name: 'ボルドーグラス',
    description: '大ぶりで背の高いボウル。フルボディの赤ワイン用',
    imageUrl: '/images/glasses/bordeaux.webp',
    characteristics: ['大容量', '縦長ボウル', 'タンニン対応'],
    suitableFor: ['red'],
    volume: 650,
    manufacturer: 'Riedel'
  },
  {
    id: 'burgundy',
    name: 'ブルゴーニュグラス',
    description: 'ボウルが広く浅い。繊細な赤ワイン用',
    imageUrl: '/images/glasses/burgundy.webp',
    characteristics: ['広いボウル', '香り拡散', '繊細なワイン用'],
    suitableFor: ['red'],
    volume: 700,
    manufacturer: 'Riedel'
  },
  {
    id: 'chardonnay',
    name: 'シャルドネグラス',
    description: '中程度のボウル。樽熟成白ワイン用',
    imageUrl: '/images/glasses/chardonnay.webp',
    characteristics: ['中程度ボウル', '樽香対応', '複雑性表現'],
    suitableFor: ['white'],
    volume: 580,
    manufacturer: 'Riedel'
  },
  {
    id: 'sauvignon',
    name: 'ソーヴィニヨン・ブラングラス',
    description: '小さめのボウル。フレッシュな白ワイン用',
    imageUrl: '/images/glasses/sauvignon.webp',
    characteristics: ['小さめボウル', 'フレッシュさ保持', '酸味強調'],
    suitableFor: ['white'],
    volume: 440,
    manufacturer: 'Riedel'
  },
  {
    id: 'flute',
    name: 'フルートグラス',
    description: '細長い形状。スパークリングワイン用',
    imageUrl: '/images/glasses/flute.webp',
    characteristics: ['細長形状', '泡持続', 'エレガント'],
    suitableFor: ['sparkling'],
    volume: 300,
    manufacturer: 'Schott Zwiesel'
  },
  {
    id: 'coupe',
    name: 'クープグラス',
    description: '浅い皿状。ヴィンテージスパークリング用',
    imageUrl: '/images/glasses/coupe.webp',
    characteristics: ['浅い皿状', 'ヴィンテージ感', '香り拡散'],
    suitableFor: ['sparkling'],
    volume: 240,
    manufacturer: 'Baccarat'
  },
  {
    id: 'dessert',
    name: 'デザートワイングラス',
    description: '小さめのボウル。甘口ワイン用',
    imageUrl: '/images/glasses/dessert.webp',
    characteristics: ['小容量', '集中感', '甘味バランス'],
    suitableFor: ['dessert', 'fortified'],
    volume: 190,
    manufacturer: 'Riedel'
  },
  {
    id: 'universal',
    name: 'ユニバーサルグラス',
    description: '汎用性の高い標準的なワイングラス',
    imageUrl: '/images/glasses/universal.webp',
    characteristics: ['汎用性', 'バランス型', 'コスパ良'],
    suitableFor: ['red', 'white', 'rose'],
    volume: 520,
    manufacturer: 'Spiegelau'
  }
];
```

### 3.4 過去記録引用システム
```typescript
interface PastRecordReference {
  recordId: string;
  wineName: string;
  producer: string;
  vintage?: number;
  rating: number;
  tastingDate: string;
  previewText: string;        // ノートの最初の100文字
  availableFields: string[];  // 引用可能フィールド
  citationCount: number;      // 被引用回数
}

interface CitationPreview {
  sourceRecord: PastRecordReference;
  selectedFields: string[];
  previewData: Partial<TastingRecord>;
  conflictFields: string[];   // 既存データと競合するフィールド
  estimatedSaveTime: number;  // 推定入力時間短縮（秒）
}

interface CitationHistory {
  citationId: string;
  sourceRecordId: string;
  targetRecordId: string;
  citedFields: string[];
  citationType: 'full' | 'partial' | 'reference';
  citedAt: Date;
  userModified: boolean;      // 引用後にユーザーが編集したか
}
```

## 4. 認証システム

### 4.1 AuthContext 詳細 (`contexts/AuthContext.tsx`)
```typescript
interface AuthContextType {
  currentUser: FirebaseUser | null;
  userProfile: User | null;
  loading: boolean;
  signInWithGoogle: () => Promise<UserCredential>;
  signInWithGoogleAndMigrateData: () => Promise<void>;
  logout: () => Promise<void>;
  hasGuestData: () => boolean;
  getGuestDataSummary: () => GuestDataSummary;
}

interface GuestDataSummary {
  totalRecords: number;
  totalQuizAttempts: number;
  achievements: string[];
}
```

**主要機能**:
- **Google OAuth**: 単一認証方式
- **ゲストモード**: localStorage による一時データ保存
- **データ移行**: ゲスト → 認証ユーザーの自動移行
- **プロフィール同期**: Firebase User → Firestore User の自動同期
- **XP計算**: ログイン時の自動レベル判定

## 6. エラーハンドリング・監視システム

### 6.1 中央集権的エラー管理 (`contexts/ErrorContext.tsx`)
```typescript
interface AppError {
  id: string;
  type: 'network' | 'auth' | 'validation' | 'server' | 'unknown';
  message: string;          // 技術的メッセージ
  userMessage: string;      // ユーザーフレンドリーメッセージ
  timestamp: number;
  retry?: () => Promise<void>;
  autoRetry: boolean;
  details?: any;
}
```

**機能**:
- **Firebase エラー分類**: 自動的なユーザーフレンドリーメッセージ変換
- **リトライ機能**: 指数バックオフによる自動再試行
- **自動破棄**: 非クリティカルエラーの10秒自動削除
- **回復可能性**: ネットワークエラーに対するインテリジェントリトライ

### 6.2 エラー追跡準備 (`services/errorTrackingService.ts`)
```typescript
interface ErrorTrackingConfig {
  environment: 'development' | 'production';
  release: string;
  userId?: string;
  tags?: Record<string, string>;
}
```

**Sentry統合準備**:
- **セッション追跡**: ユーザーセッション管理
- **コンテキスト情報**: エラー発生時の詳細な状況
- **パフォーマンス監視**: フック準備済み
- **プライバシー**: ユーザーデータの自動フィルタリング

## 7. 通知システム

### 7.1 プッシュ通知 (`services/notificationService.ts`)
```typescript
interface NotificationConfig {
  types: {
    streak_reminder: boolean;
    quiz_reminder: boolean;
    badge_earned: boolean;
    weekly_summary: boolean;
    heart_recovery: boolean;
    friend_activity: boolean;
  };
  quietHours: {
    start: string;          // "22:00"
    end: string;            // "08:00"
    enabled: boolean;
  };
  frequency: 'high' | 'medium' | 'low';
}
```

### 7.2 スケジューラー (`services/notificationScheduler.ts`)
```typescript
interface ScheduledNotification {
  type: NotificationType;
  scheduledFor: Date;
  userId: string;
  payload: NotificationPayload;
  recurring?: {
    pattern: 'daily' | 'weekly';
    interval: number;
  };
}
```

**機能**:
- **スマートスケジューリング**: ユーザー活動パターン分析
- **静寂時間**: 夜間通知の自動回避
- **パーソナライゼーション**: ユーザー統計に基づくメッセージ
- **Service Worker統合**: バックグラウンド通知処理

## 8. ゲーミフィケーションシステム

### 8.1 XPシステム (`services/gamificationService.ts`)
```typescript
const XP_REWARDS = {
  WINE_RECORD_QUICK: 10,
  WINE_RECORD_DETAILED: 20,
  QUIZ_CORRECT: 5,
  DAILY_GOAL_COMPLETE: 50,
  BADGE_EARNED: 100,
  STREAK_BONUS: 10,         // 最大10日間
};

// レベル計算: 指数進行（1.2倍）
function calculateLevel(xp: number): number {
  // ベース: 100 XP, 各レベル+20%
}
```

### 8.2 バッジシステム (`data/badges.ts`)
```typescript
// 67個のバッジ（4カテゴリー）
{
  recording: 12段階,      // 1, 3, 5, 10, 25, 50, 100, 200, 500, 1000, 2000, 5000本
  streak: 10段階,         // 3, 7, 14, 30, 50, 100, 200, 365, 500, 1000日
  quiz: 15段階,           // 完走・ストリーク・正解数
  exploration: 30段階     // 国・品種・価格帯・年代の多様性
}
```

### 8.3 日常目標システム
```typescript
interface DailyGoal {
  userId: string;
  date: string;             // YYYY-MM-DD
  wineRecordingGoal: number;
  quizGoal: number;
  wineRecordingCompleted: number;
  quizCompleted: number;
  xpEarned: number;
}
```

## 9. クイズシステム（実装完了）

### 9.1 問題構成
- **総問題数**: 20レベル × 100問 = 2,000問
- **問題形式**: 4択選択式（選択肢配列 + 正解インデックス + 解説）
- **問題ID形式**: `L{レベル}_{3桁連番}` (例: L01_001, L15_087)

### 9.2 レベル別ジャンル詳細
```typescript
// 20レベルの詳細分類
export const QUIZ_LEVELS = [
  // 初心者レベル（1-5）
  { level: 1, name: 'ワインの基本', description: '赤・白・ロゼ・スパークリング' },
  { level: 2, name: '主要ブドウ品種', description: '国際品種中心' },
  { level: 3, name: '基本的なテイスティング技法', description: 'テイスティングの基礎' },
  { level: 4, name: 'ワインサービスとマナー', description: 'サービスの基本' },
  { level: 5, name: '基本的なフードペアリング', description: '料理との相性' },
  
  // 中級者レベル（6-10）
  { level: 6, name: 'フランスワイン基礎', description: '主要産地' },
  { level: 7, name: 'イタリア・ドイツ・スペインワイン', description: '欧州三大産地' },
  { level: 8, name: '新世界ワイン', description: 'アメリカ・オーストラリア等' },
  { level: 9, name: 'ワイン製造技術詳細', description: '醸造プロセス' },
  { level: 10, name: 'ヴィンテージと熟成', description: '年代と熟成' },
  
  // 上級者レベル（11-15）
  { level: 11, name: 'フランス各地方詳細', description: 'ボルドー・ブルゴーニュ' },
  { level: 12, name: '世界各国のワイン法規制', description: '法律と規制' },
  { level: 13, name: 'プロテイスティング・ブラインド技法', description: '上級テイスティング' },
  { level: 14, name: '稀少品種・マイナー産地', description: '珍しい品種と産地' },
  { level: 15, name: 'ワインビジネス・流通', description: 'ビジネス側面' },
  
  // エキスパートレベル（16-20）
  { level: 16, name: '歴史的ヴィンテージ・伝説的ワイン', description: '歴史と伝説' },
  { level: 17, name: '最新醸造技術・イノベーション', description: '技術革新' },
  { level: 18, name: 'ワイン投資・ビジネス理論', description: '投資と経営' },
  { level: 19, name: '総合酒類知識', description: '日本酒・ウイスキー等' },
  { level: 20, name: 'ワイン哲学・心理学・文化論', description: '文化と心理' }
]
```

### 9.3 問題データ形式
```typescript
interface QuizQuestion {
  id: string;               // 例: 'L01_001'
  category: string;         // レベル名と同じ
  question: string;         // 問題文
  options: string[];        // 4つの選択肢
  correctAnswer: number;    // 正解のインデックス（0-3）
  explanation?: string;     // 解説（任意）
}

// 実装例
{
  id: 'L01_001',
  difficulty: 1,
  category: 'ワインの基本',
  question: 'ワインの主な原料は何ですか？',
  options: ['米', 'ブドウ', '麦', 'りんご'],
  correctAnswer: 1,
  explanation: 'ワインはブドウを発酵させて作られるアルコール飲料です。'
}
```

### 9.2 動的読み込みシステム (`data/quiz/index.ts`)
```typescript
// レベル別遅延読み込み
const levelImportMap: Record<number, () => Promise<{ default: QuizQuestion[] }>>
const questionCache: Map<number, QuizQuestion[]>

// 使用例
await loadQuestionsByLevel(5);
await loadQuestionsByRange(1, 10);
```

### 9.3 学習進捗管理 (`services/quizProgressService.ts`)
```typescript
interface QuizProgress {
  userId: string;
  difficulty: number;
  completedQuestions: string[];
  correctAnswers: number;
  totalAttempts: number;
  bestScore: number;
  lastPlayedAt: Timestamp;
}

interface UserQuizStats {
  heartsRemaining: number;
  heartsRecoveryTime: Timestamp | null;
  currentStreak: number;
  longestStreak: number;
  overallAccuracy: number;
}
```

**機能**:
- **ハートシステム**: 5ライフ、30分回復間隔
- **間違い復習**: 間隔反復学習アルゴリズム
- **ストリーク追跡**: 連続正解の検出と報酬

## 10. 高度なUIコンポーネント

### 10.1 ワインフィルター (`components/WineFilter.tsx`)
```typescript
interface WineFilterOptions {
  countries: string[];
  grapeVarieties: string[];
  wineTypes: ('red' | 'white' | 'rose' | 'sparkling' | 'dessert' | 'fortified')[];
  priceRange: { min: number | null; max: number | null; };
  ratingRange: { min: number | null; max: number | null; };
  vintageRange: { min: number | null; max: number | null; };
  searchText: string;
}
```

**機能**:
- **4タブUI**: 種類・産地品種・価格年代・評価
- **動的候補**: ユーザーデータに基づく推奨選択肢
- **アクティブフィルター表示**: リアルタイムカウント
- **レンジ入力**: 双方向数値範囲指定

### 10.2 手描きキャンバス (`components/DrawingCanvas.tsx`)
```typescript
interface DrawingCanvasProps {
  onSave?: (dataUrl: string) => void;
  width?: number;           // デフォルト400px
  height?: number;          // デフォルト300px
  className?: string;
}
```

**機能**:
- **描画ツール**: ペン・消しゴム切り替え
- **設定**: ブラシサイズ（1-20px）、カラーピッカー
- **入力対応**: マウス・タッチの統一処理
- **出力**: PNG形式のData URL生成

### 10.3 テイスティング分析チャート (`components/TastingAnalysisCharts.tsx`)
```typescript
// Chart.js統合による3種類の可視化
1. 成分バランス: レーダーチャート
   - 軸: 酸味・タンニン・甘味・ボディ・アルコール感
   - スケール: 0-10点
   
2. 香りカテゴリー: 棒グラフ
   - カテゴリー: 果実・花・スパイス・ハーブ・土・木・その他
   - カラーコード: カテゴリー別固有色
   
3. 味わいの展開: 線グラフ
   - 段階: アタック→展開→フィニッシュ
   - テンション: 0.4（滑らかな曲線）
```

### 10.4 タグ入力 (`components/TagInput.tsx`)
```typescript
// インタラクティブなタグ管理
- 入力方式: Enter/カンマ区切り
- 削除機能: Backspace（空入力時）+ 個別削除ボタン
- 重複防止: 自動重複チェック
- フォーカス管理: コンテナクリックでフォーカス
```

## 11. セキュリティ実装

### 11.1 Firestore Security Rules (`firestore.rules`)
```typescript
// 181行の包括的セキュリティルール

// 認証・認可
function isAuthenticated(): request.auth != null
function isOwner(userId): request.auth.uid == userId
function isValidEmail(): request.auth.token.email != null

// データ検証
function isValidRating(rating): 0 <= rating <= 10
function isValidRecordMode(mode): mode in ['quick', 'detailed']
function isValidWineMasterData(data): 必須フィールド存在チェック
```

**保護対象**:
- **tasting_records**: 所有者限定 + 厳密な型検証
- **users**: 所有者限定 + 不変フィールド保護
- **drafts**: 所有者限定 + サイズ制限（50フィールド）

### 11.2 Storage Security Rules (`storage.rules`)
```typescript
// 階層別アクセス制御
/wine-images/{userId}/: {
  read: public,           // ワイン画像は公開
  write: owner_only,      // 10MB制限
  formats: ['jpeg', 'png', 'webp']
}

/user-avatars/{userId}/: {
  read: owner_only,       // アバターは非公開
  write: owner_only,      // 2MB制限
  formats: ['jpeg', 'png', 'webp']
}
```

## 12. PWA機能実装

### 12.1 Service Worker設定 (`vite.config.ts`)
```typescript
// Workbox詳細設定
workbox: {
  navigateFallbackDenylist: [
    /^\/__\/.*$/,           // Firebase内部API
    /^\/google\.firestore\.v1/,
    /^.*\.googleapis\.com\//,
    /\.(?:png|jpg|js|css)$/ // 静的ファイル
  ],
  runtimeCaching: [
    // Firebase Storage: StaleWhileRevalidate（30日）
    // 静的画像: CacheFirst（1年）
    // フォント: CacheFirst（1年）
    // Firebase API: NetworkOnly（キャッシュなし）
  ]
}
```

### 12.2 通知処理 (`firebase-messaging-sw.js`)
```typescript
// バックグラウンド通知の処理
onBackgroundMessage: {
  title: payload.notification?.title || 'MyWineMemory',
  icon: '/android/mipmap-mdpi/ic_launcher.png',
  actions: [
    { action: 'open', title: 'アプリを開く' },
    { action: 'dismiss', title: '後で' }
  ]
}

// 通知クリック時のルーティング
{
  'streak_reminder' → '/select-wine',
  'quiz_reminder' → '/quiz',
  'badge_earned' → '/profile'
}
```

### 12.3 アプリマニフェスト
```json
{
  "name": "MyWineMemory",
  "short_name": "WineMemory",
  "theme_color": "#722F37",
  "background_color": "#FFF8E1",
  "display": "standalone",
  "orientation": "portrait",
  "categories": ["food", "lifestyle", "education"],
  "icons": [
    // 27種類のアイコン（iOS/Android/PWA対応）
    // 48x48 〜 512x512 + SVG
  ]
}
```

## 13. テーマシステム実装

### 13.1 CSS設計 (`App.css`)
```css
/* CSS Custom Properties による包括的テーマ */
:root {
  /* ダークテーマ: バー雰囲気 */
  --text-primary: #ffffff;
  --bg-primary: #1a1a1a;
  --card-bg: #2a2a2a;
  --primary-color: #722F37;
}
```

### 13.2 レスポンシブ設計
```css
/* 全幅レイアウト戦略 */
.app {
  width: 100vw;
  overflow-x: hidden;
}

.page-container {
  width: 100%;
  max-width: 100vw;
  padding: 1rem;
}

/* モバイルファースト: 320px〜 */
```

### 13.3 ThemeContext (`contexts/ThemeContext.tsx`)
```typescript
interface ThemeContextType {
  theme: 'light' | 'dark';
  toggleTheme: () => void;
  systemPreference: 'light' | 'dark';
}
```

**機能**:
- **自動検出**: システム設定の初期読み込み
- **永続化**: localStorage による設定保存
- **リアルタイム更新**: HTML data-theme属性の即座更新

## 14. アクセシビリティ実装

### 14.1 キーボード・スクリーンリーダー対応
```css
/* フォーカス管理 */
*:focus-visible {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

/* スクリーンリーダー対応 */
.skip-to-content {
  position: absolute;
  top: -40px;              /* 通常時は非表示 */
}
```

### 14.2 ARIA属性の活用
```typescript
// 実装箇所
- WineFilter: aria-expanded, aria-label
- BottomNavigation: 現在ページの識別
- LoadingSpinner: aria-live="polite"
- ErrorMessage: role="alert"
```

## 15. ルーティング・ナビゲーション

### 15.1 ルート構成 (`App.tsx`)
```typescript
// React Router v7による宣言的ルーティング
<Routes>
  <Route path="/" element={<Home />} />
  <Route path="/records" element={<Records />} />
  <Route path="/select-wine" element={<SelectWine />} />
  <Route path="/add-tasting-record" element={<AddTastingRecord />} />
  <Route path="/edit-tasting-record/:recordId" element={<AddTastingRecord />} />
  <Route path="/wine-detail/:wineId" element={<WineDetail />} />
  <Route path="/quiz" element={<Quiz />} />
  <Route path="/quiz/play/:difficulty" element={<QuizGame />} />
  <Route path="/stats" element={<Stats />} />
  <Route path="/profile" element={<Profile />} />
  <Route path="/profile/:userId" element={<PublicProfile />} />
</Routes>
```

### 15.2 ボトムナビゲーション (`components/BottomNavigation.tsx`)
```typescript
const navItems = [
  { path: '/', icon: '🏠', label: 'ホーム' },
  { path: '/records', icon: '📝', label: '記録' },
  { path: '/quiz', icon: '🧠', label: 'クイズ' },
  { path: '/stats', icon: '📊', label: '統計' },
  { path: '/profile', icon: '👤', label: 'プロフィール' },
];
```

**機能**:
- **アクティブ状態**: 現在パスのハイライト
- **アクセシビリティ**: 各アイテムのラベル付け
- **固定配置**: 80px高さでメインコンテンツとの間隔調整

### 15.3 スクロール管理
```typescript
// ScrollToTop コンポーネント
function ScrollToTop() {
  const { pathname } = useLocation();
  useEffect(() => {
    window.scrollTo(0, 0);
  }, [pathname]);
  return null;
}
```

## 16. サービスレイヤー詳細

### 16.1 TastingRecord Service (`services/tastingRecordService.ts`)
```typescript
// 主要API
interface TastingRecordService {
  // 基本CRUD
  createRecord(userId: string, recordData: Partial<TastingRecord>): Promise<string>;
  getRecord(recordId: string): Promise<TastingRecord | null>;
  updateRecord(recordId: string, updates: Partial<TastingRecord>): Promise<void>;
  deleteRecord(recordId: string): Promise<void>;
  
  // 検索・フィルタリング
  searchUserWines(userId: string, searchTerm: string, limit?: number): Promise<TastingRecord[]>;
  getUserRecords(userId: string, filters?: WineFilterOptions): Promise<TastingRecord[]>;
  getPopularWines(userId: string, limit: number): Promise<PopularWine[]>;
  
  // 統計
  getUserStats(userId: string): Promise<UserStats>;
  getCountryDistribution(userId: string): Promise<Record<string, number>>;
  
  // 画像処理
  uploadImages(files: File[], userId: string): Promise<string[]>;
  optimizeImageForUpload(file: File): Promise<File>;
}
```

**高度機能**:
- **重複検出**: ワイン名・生産者による類似ワイン検索
- **画像最適化**: WebP変換とフォールバック
- **統計計算**: リアルタイム集計とキャッシュ
- **公開記録**: プライバシー制御付きの共有機能

### 16.2 Gamification Service (`services/gamificationService.ts`)
```typescript
interface GamificationService {
  // XP管理
  calculateXP(activityType: string, details?: any): number;
  addXP(userId: string, amount: number, reason: string): Promise<void>;
  
  // レベル管理
  checkLevelUp(userId: string, newXP: number): Promise<boolean>;
  
  // ストリーク管理
  updateStreak(userId: string): Promise<number>;
  checkStreakFreeze(userId: string): Promise<boolean>;
  
  // バッジ管理
  checkAndAwardBadges(userId: string): Promise<Badge[]>;
  
  // 日常目標
  updateDailyGoals(userId: string, activityType: string): Promise<void>;
}
```

## 17. 料金システム（実装予定）

### 17.1 プラン比較
| 機能 | 無料プラン | 有料プラン（500円/月） |
|------|-----------|----------------------|
| **ワイン記録** | 1ワインにつき2記録まで | 無制限 |
| **画像アップロード** | 1枚まで | 4枚まで |
| **詳細分析** | 制限あり | 全機能 |
| **LLMクイズ** | 月10回まで | 無制限 |
| **データエクスポート** | なし | CSV/JSON |
| **高度統計** | 基本のみ | 詳細分析 |
今後追加予定。

### 17.2 Stripe統合方針
```typescript
// 実装予定の構造
interface SubscriptionStatus {
  plan: 'free' | 'premium';
  stripeCustomerId?: string;
  subscriptionId?: string;
  currentPeriodEnd?: Date;
  cancelAtPeriodEnd?: boolean;
}

interface SubscriptionService {
  createCheckoutSession(userId: string, priceId: string): Promise<string>;
  createPortalSession(customerId: string): Promise<string>;
  handleWebhook(event: Stripe.Event): Promise<void>;
  checkSubscriptionStatus(userId: string): Promise<SubscriptionStatus>;
}
```

## 19. パフォーマンス最適化

### 19.1 遅延読み込み戦略
```typescript
// React.lazy による完全分割
const Home = React.lazy(() => import('./pages/Home'));
const SelectWine = React.lazy(() => import('./pages/SelectWine'));
// ...全ページコンポーネント
```

### 19.2 検索最適化
```typescript
// デバウンス検索（300ms）
useEffect(() => {
  const timeoutId = setTimeout(searchWines, 300);
  return () => clearTimeout(timeoutId);
}, [searchTerm]);
```

### 19.3 画像最適化
```typescript
// WebP変換パイプライン
interface ImageProcessing {
  format: 'webp-first';
  fallback: 'original-format';
  maxSize: 10 * 1024 * 1024;  // 10MB
  compression: 'automatic';
}
```

### 19.4 バンドル分析
```typescript
// rollup-plugin-visualizer設定
visualizer({
  filename: 'dist/stats.html',
  template: 'treemap',
  gzipSize: true,
  brotliSize: true
})
```

## 20. 国際化・地域化

### 20.1 言語設定
- **UI言語**: 日本語専用
- **データベース**: 英語フィールド名 + 日本語コンテンツ
- **エラーメッセージ**: 日本語ユーザーフレンドリー
- **通知**: 日本語テンプレート

### 20.2 地域化要素
```typescript
// 日本市場特化設定
{
  currency: 'JPY',
  dateFormat: 'YYYY-MM-DD',
  timeZone: 'Asia/Tokyo',
  numberFormat: '3,000円'
}
```

## 21. 運用・監視

### 21.1 環境設定管理
```typescript
// scripts/validate-env.js
必須環境変数の検証:
- VITE_FIREBASE_API_KEY
- VITE_FIREBASE_AUTH_DOMAIN
- VITE_FIREBASE_PROJECT_ID
- VITE_FIREBASE_STORAGE_BUCKET
- VITE_FIREBASE_MESSAGING_SENDER_ID
- VITE_FIREBASE_APP_ID
- VITE_FIREBASE_VAPID_KEY
```

### 21.2 ビルド・デプロイ戦略
```json
{
  "scripts": {
    "build": "npm run validate:env && tsc -b && vite build",
    "security:check": "npm audit && npm run validate:env",
    "pre-commit": "npm run lint && npm run test && npm run validate:env"
  }
}
```

### 21.3 Firebase設定
```json
// firebase.json
{
  "hosting": {
    "public": "dist",
    "ignore": ["firebase.json", "**/.*", "**/node_modules/**"],
    "rewrites": [{ "source": "**", "destination": "/index.html" }]
  },
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "storage": {
    "rules": "storage.rules"
  }
}
```

## 22. テスト・品質管理

### 22.1 テスト設定
```typescript
// Jest + Testing Library設定
{
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/test/setup.ts'],
  moduleNameMapping: {
    '\\.(css|less|scss)$': 'identity-obj-proxy'
  }
}
```

### 22.2 実装済みテスト
- **Component Tests**: ErrorMessage, LoadingSpinner, WineCard
- **Hook Tests**: useErrorHandler
- **Service Tests**: wineMasterService, indexedDBService

### 22.3 品質管理
```typescript
// ESLint設定
{
  extends: ['@eslint/js', 'react-hooks', 'react-refresh'],
  rules: {
    'react-hooks/exhaustive-deps': 'warn',
    'react-refresh/only-export-components': 'warn'
  }
}
```

## 23. 将来拡張ポイント

### 23.1 コミュニティ機能準備
- **パブリックプロフィール**: PublicProfile.tsx 実装済み
- **記録共有**: isPublic フラグによる制御
- **スラッグ機能**: publicSlug による友好的URL

### 23.2 分析・統計拡張
```typescript
interface UserStats {
  monthlyRecords: { [key: string]: number };
  countryDistribution: { [country: string]: number };
  varietyDistribution: { [variety: string]: number };
  priceRangeAnalysis: object;
  tastingPatterns: object;
}
```

### 23.3 AI機能統合準備
- **LLM評価**: OpenRouter/Groq API準備
- **パーソナライズドクイズ**: ユーザー記録ベース問題生成
- **推奨システム**: 味覚プロファイル分析

## 24. コスト・KPI管理

### 24.1 運用コスト構造
- **Firebase**: 〜800円/月
- **LLM API**: 〜200円/月（制限あり）
- **ドメイン・SSL**: 〜100円/月
- **総額**: 1,100円/月未満

### 24.2 成功指標
- **エンゲージメント**: MAU、記録頻度、クイズ継続率
- **ビジネス**: 有料転換率、MRR、CAC、LTV
- **技術**: 初期ロード3秒以内、PWAインストール率

## 25. 三段階ワークフロー（実装済み）

### 25.1 Step 1: ワイン選択 (`/select-wine`)
```typescript
// SelectWine.tsx の機能
- 人気ワイン表示（ユーザー固有上位10件）
- リアルタイム検索（300msデバウンス）
- 新規ワイン作成フォーム
- TagInput による品種入力
- 既存ワインとの重複検出
```

### 25.2 Step 2: テイスティング記録 (`/add-tasting-record`)
```typescript
// AddTastingRecord.tsx の機能
- クイック・詳細モード切り替え
- 画像アップロード（WebP最適化）
- 詳細分析入力（appearance, aroma, taste, structure）
- DrawingCanvas 統合
- 環境情報記録
```

### 25.3 Step 3: 記録確認 (`/records`, `/wine-detail`)
```typescript
// Records.tsx: ワイン別グループ表示
- WineFilter による高度絞り込み
- 統計情報表示（総記録数、平均評価）
- 日付ソート、公開/非公開切り替え

// WineDetail.tsx: 個別ワイン詳細
- 時系列テイスティング履歴
- TastingAnalysisCharts 表示
- 記録の編集・削除
- 画像ギャラリー
```

## 26. 新バージョン検知・自動更新システム

### 26.1 Service Worker更新戦略
```typescript
// vite.config.ts - 拡張PWA設定
workbox: {
  skipWaiting: true,              // 新バージョンを即座に有効化
  clientsClaim: true,             // すべてのクライアントを制御
  cleanupOutdatedCaches: true,    // 古いキャッシュを自動削除
  
  runtimeCaching: [
    {
      urlPattern: /\.(?:js|css)$/,
      handler: 'StaleWhileRevalidate',  // 古いものを表示しつつ更新確認
      options: {
        cacheName: 'static-resources',
        expiration: {
          maxEntries: 30,
          maxAgeSeconds: 24 * 60 * 60    // 24時間
        }
      }
    },
    {
      urlPattern: /\.(?:png|jpg|jpeg|svg|gif|webp|ico)$/,
      handler: 'CacheFirst',
      options: {
        cacheName: 'images',
        expiration: {
          maxEntries: 100,
          maxAgeSeconds: 365 * 24 * 60 * 60  // 1年
        }
      }
    }
  ]
}
```

### 26.2 新バージョン検知サービス
```typescript
// services/updateService.ts
interface UpdateService {
  // バージョン管理
  checkForUpdates(): Promise<boolean>;
  getCurrentVersion(): string;
  getLatestVersion(): Promise<string>;
  
  // 更新通知
  notifyUpdate(options: {
    title: string;
    message: string;
    actions: UpdateAction[];
  }): void;
  
  // 自動更新設定
  autoUpdateConfig: {
    checkInterval: number;        // 更新チェック間隔（ミリ秒）
    showNotification: boolean;    // 通知表示有無
    autoReload: boolean;          // 自動リロード有無
    silentUpdate: boolean;        // サイレント更新
  };
}

// hooks/useUpdateChecker.ts
function useUpdateChecker() {
  const [updateAvailable, setUpdateAvailable] = useState(false);
  const [isUpdating, setIsUpdating] = useState(false);
  
  useEffect(() => {
    // Service Worker登録と更新監視
    registerSW({
      onNeedRefresh() {
        setUpdateAvailable(true);
        showUpdateToast({
          title: '新しいバージョンが利用可能です',
          message: 'アプリを更新して最新機能をご利用ください',
          actions: [
            { label: '今すぐ更新', action: 'update' },
            { label: '後で', action: 'dismiss' }
          ]
        });
      },
      onOfflineReady() {
        console.log('オフライン対応準備完了');
      },
      immediate: true
    });
    
    // 定期的な更新チェック（1時間ごと）
    const interval = setInterval(() => {
      checkForUpdates();
    }, 60 * 60 * 1000);
    
    return () => clearInterval(interval);
  }, []);
  
  const applyUpdate = async () => {
    setIsUpdating(true);
    await updateServiceWorker();
    window.location.reload();
  };
  
  return { updateAvailable, isUpdating, applyUpdate };
}
```

### 26.3 キャッシュ戦略とバージョニング
```typescript
// vite.config.ts - ビルド設定
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        // ファイル名にハッシュを含める（キャッシュ無効化）
        entryFileNames: 'assets/[name].[hash].js',
        chunkFileNames: 'assets/[name].[hash].js',
        assetFileNames: 'assets/[name].[hash].[ext]'
      }
    },
    manifest: true,    // マニフェスト生成
    sourcemap: process.env.NODE_ENV !== 'production'
  },
  
  // 環境変数でバージョン管理
  define: {
    __APP_VERSION__: JSON.stringify(process.env.npm_package_version),
    __BUILD_TIME__: JSON.stringify(new Date().toISOString())
  }
});
```

### 26.4 Firebase Hostingヘッダー設定
```json
// firebase.json
{
  "hosting": {
    "headers": [
      {
        "source": "**/*.@(js|css)",
        "headers": [{
          "key": "Cache-Control",
          "value": "public, max-age=31536000, immutable"  // ハッシュ付きファイルは永続キャッシュ
        }]
      },
      {
        "source": "index.html",
        "headers": [{
          "key": "Cache-Control",
          "value": "no-cache, no-store, must-revalidate"  // HTMLは常に最新
        }]
      },
      {
        "source": "**/*.@(jpg|jpeg|gif|png|svg|webp)",
        "headers": [{
          "key": "Cache-Control",
          "value": "public, max-age=86400, s-maxage=2592000"  // 画像は1日/CDN30日
        }]
      }
    ]
  }
}
```

### 26.5 更新通知UI
```typescript
// components/UpdateNotification.tsx
interface UpdateNotificationProps {
  version: string;
  changelog?: string[];
  onUpdate: () => void;
  onDismiss: () => void;
}

function UpdateNotification({ version, changelog, onUpdate, onDismiss }: UpdateNotificationProps) {
  return (
    <div className="update-notification" role="alert" aria-live="polite">
      <div className="update-header">
        <span className="update-icon">🔄</span>
        <h3>バージョン {version} が利用可能です</h3>
      </div>
      
      {changelog && (
        <ul className="update-changelog">
          {changelog.map((change, index) => (
            <li key={index}>{change}</li>
          ))}
        </ul>
      )}
      
      <div className="update-actions">
        <button onClick={onUpdate} className="btn-primary">
          今すぐ更新
        </button>
        <button onClick={onDismiss} className="btn-secondary">
          後で通知
        </button>
      </div>
    </div>
  );
}
```

### 26.6 実装のポイント

#### 自動更新の流れ:
1. **ビルド時**: ファイル名にハッシュを含めて生成
2. **デプロイ時**: Firebase Hostingに新バージョンアップロード
3. **ユーザーアクセス時**: Service Workerが更新チェック
4. **更新検知時**: 通知表示またはサイレント更新
5. **更新適用**: ページリロードで新バージョン有効化

#### メリット:
- **キャッシュクリア不要**: ハッシュによる自動無効化
- **ユーザー体験向上**: 更新通知と選択的更新
- **オフライン対応**: Service Workerによるキャッシュ管理
- **パフォーマンス**: StaleWhileRevalidate戦略で高速表示

---

この包括的技術仕様書により、他のAIは現行の実装レベルを正確に理解し、適切な開発継続・機能拡張・保守作業が実行可能になります。実装済み機能の詳細から将来の拡張方針まで、必要な技術情報を網羅しています。