# MyWineMemory 現行実装仕様書

## 1. プロジェクト概要

### 1.1 基本情報

**サイト名**: MyWineMemory  
**URL**: my-wine-memory.himazi.com  
**プロジェクトステータス**: 実装中（部分的に稼働）

**技術スタック**:
- **フロントエンド**: React 18 + TypeScript + Vite
- **バックエンド**: Firebase (Firestore, Authentication, Storage, Hosting)
- **CI/CD**: GitHub Actions

### 1.2 実装コンセプト

飲んだワインを記録し、クイズで学習できるWebアプリケーション。ユーザーごとにテイスティング記録を管理し、統計情報を表示。

## 2. 実装済み機能

### 2.1 認証システム

**実装内容**:
- ✅ Google OAuth認証（Firebase Authentication）
- ✅ ゲストモード（ローカルストレージ使用）
- ✅ ゲストデータのログイン時移行機能

**AuthContext機能**:
```typescript
- signInWithGoogle()
- signInWithGoogleAndMigrateData()
- logout()
- hasGuestData()
- getGuestDataSummary()
```

### 2.2 ワイン記録システム

#### 2.2.1 データ構造（統合型）

**TastingRecord** (コレクション: `tasting_records`):
- ユーザーごとのワイン記録を一元管理
- WineMasterの分離は未実装（型定義のみ存在）

```typescript
TastingRecord {
  id: string
  userId: string
  wineId: string  // 現在は使用されていない
  
  // ワイン基本情報
  wineName: string
  producer: string
  country: string
  region: string
  vintage?: number
  grapeVarieties?: string[]
  wineType?: 'red' | 'white' | 'rose' | 'sparkling' | 'dessert' | 'fortified'
  alcoholContent?: number
  
  // テイスティング情報
  overallRating: number  // 0.0-10.0
  tastingDate: Date
  recordMode: 'quick' | 'detailed'
  notes?: string
  price?: number
  purchaseLocation?: string
  
  // 詳細分析（型定義あり、UI実装不明）
  detailedAnalysis?: {...}
  environment?: {...}
  
  // メディア・メタデータ
  images?: string[]
  isPublic: boolean
  createdAt: Date
  updatedAt: Date
}
```

#### 2.2.2 実装済みワークフロー

**現行の3ステップフロー**:
1. `/select-wine` - 既存ワインから検索・選択
2. `/add-tasting-record/:wineId` - テイスティング記録入力
3. `/records` - 記録一覧表示

**サービス機能** (`tastingRecordService`):
- `searchUserWines()` - ユーザーのワイン検索
- `getUserPopularWines()` - 人気ワイン取得
- `getUserTastingRecords()` - テイスティング記録取得
- `createTastingRecord()` - 新規記録作成
- `updateTastingRecord()` - 記録更新
- `deleteTastingRecord()` - 記録削除

### 2.3 ユーザープロフィール機能

**User型定義**:
```typescript
User {
  id: string
  email: string
  displayName: string
  photoURL?: string
  nickname?: string
  level: number
  xp: number
  streak: number
  totalRecords: number
  badges: Badge[]  // 型定義のみ、実装なし
  privacySettings?: {...}
  isPublic?: boolean
  publicSlug?: string
}
```

**userService機能**:
- `createOrUpdateUser()` - ユーザー作成/更新
- `getUserProfile()` - プロフィール取得
- `updateUserProfile()` - プロフィール更新
- `addXP()` - XP追加（部分実装）

### 2.4 クイズシステム（部分実装）

#### 2.4.1 実装済み構造

**クイズデータ** (`/src/data/quiz/`):
- 20レベル分のファイル構造あり
- 各レベルに問題データ格納
- 合計問題数は未確認

**QuizQuestion型**:
```typescript
QuizQuestion {
  id: string
  difficulty: number  // 1-10
  category: string
  question: string
  options: string[]
  correctAnswer: number
  explanation?: string
}
```

#### 2.4.2 クイズ進捗管理

**quizProgressService**:
- `getUserProgress()` - ユーザー進捗取得
- `updateQuizProgress()` - 進捗更新
- `getWrongAnswersForReview()` - 復習問題取得（UI未実装）

**実装済み機能**:
- ✅ 難易度別クイズ選択
- ✅ クイズ回答・採点
- ✅ ハートシステム（5ライフ）
- ❌ 復習機能（アラート表示のみ）
- ❌ パーソナライズドクイズ（予告のみ）

### 2.5 統計機能

**Stats画面で表示される情報**:
- 総記録数
- 月別記録数グラフ
- 国別分布
- 品種別分布
- 平均評価

### 2.6 ゲストモード機能

**guestDataService**:
- ローカルストレージでの一時保存
- ワイン記録の保存
- クイズ結果の保存
- ログイン時のデータ移行

## 3. 未実装機能

### 3.1 ゲーミフィケーション
- ❌ バッジシステム（型定義のみ）
- ❌ XP・レベルシステム（部分的）
- ❌ ストリーク機能（カウントのみ）
- ❌ デイリーゴール
- ❌ ストリークフリーズ

### 3.2 データ管理
- ❌ 下書き自動保存（30秒ごと）
- ❌ ゴミ箱機能（3日間保持）
- ❌ WineMaster分離アーキテクチャ

### 3.3 UI/UX
- ❌ ダークモード（ThemeContext未実装）
- ❌ PWA通知機能
- ❌ 詳細モード/クイックモードのUI切り替え

### 3.4 高度な機能
- ❌ AI画像認識
- ❌ LLM連携（OpenRouter/Groq）
- ❌ コミュニティ機能

## 4. ページ構成

### 4.1 実装済みページ

```
/ (Home)                            # ダッシュボード
├── /select-wine                    # ワイン選択
├── /add-tasting-record/:wineId     # テイスティング記録追加
├── /records                        # 記録一覧
├── /wine-detail/:wineId           # ワイン詳細
├── /quiz                          # クイズトップ
├── /quiz/play/:difficulty         # クイズプレイ
├── /stats                         # 統計
├── /profile                       # プロフィール
└── /public/:slug                  # 公開プロフィール
```

### 4.2 コンポーネント構成

```
src/components/
├── BottomNavigation.tsx    # 下部ナビゲーション
├── WineCard.tsx            # ワインカード表示
├── LoadingSpinner.tsx      # ローディング表示
├── ErrorMessage.tsx        # エラーメッセージ
├── LoginPrompt.tsx         # ログイン促進
├── TagInput.tsx            # タグ入力
└── StatsCharts.tsx         # 統計グラフ
```

## 5. サービス層

### 5.1 実装済みサービス

```
src/services/
├── firebase.ts              # Firebase初期化
├── tastingRecordService.ts  # テイスティング記録CRUD
├── userService.ts           # ユーザー管理
├── guestDataService.ts      # ゲストデータ管理
├── quizProgressService.ts   # クイズ進捗管理
├── wineService.ts          # レガシーサービス
└── imageService.ts         # 画像アップロード
```

## 6. データベース構成

### 6.1 Firestoreコレクション

**実装済み**:
- `users` - ユーザープロフィール
- `tasting_records` - テイスティング記録（統合型）
- `quiz_progress` - クイズ進捗
- `quiz_stats` - クイズ統計

**未実装**:
- `wines_master` - ワインマスターデータ
- `drafts` - 下書き
- `trash` - ゴミ箱
- `daily_goals` - デイリーゴール
- `badges` - バッジ進捗

## 7. 開発環境

### 7.1 パッケージ構成

```json
{
  "dependencies": {
    "react": "^18.x",
    "react-router-dom": "^6.x",
    "firebase": "^10.x",
    "typescript": "^5.x",
    "vite": "^5.x"
  }
}
```

### 7.2 ビルド・デプロイ

- **開発**: `npm run dev`
- **ビルド**: `npm run build`
- **デプロイ**: GitHub Actions → Firebase Hosting

## 8. 現行の制限事項

### 8.1 技術的制限
- オフライン対応は限定的（ゲストモードのみ）
- 画像最適化なし
- レスポンシブデザインは基本レベル

### 8.2 機能的制限
- ワインの重複登録を防ぐ仕組みなし
- クイズの復習機能は未完成
- バッジ・実績システムなし

### 8.3 パフォーマンス
- 初回読み込み最適化なし
- 画像の遅延読み込みなし
- キャッシュ戦略なし

## 9. セキュリティ実装

### 9.1 実装済み
- ✅ Firebase Security Rules
- ✅ HTTPS通信
- ✅ ユーザーデータ分離

### 9.2 未実装
- ❌ レート制限
- ❌ 入力値検証の一部

## 10. 今後の開発方針

### 10.1 優先度高
1. WineMaster分離アーキテクチャの実装
2. バッジ・ゲーミフィケーション機能
3. 下書き自動保存

### 10.2 優先度中
1. ダークモード対応
2. PWA機能強化
3. クイズ復習機能

### 10.3 優先度低
1. AI機能連携
2. コミュニティ機能
3. 有料プラン

## 11. 既知の問題

1. **データ構造**: WineMasterが未実装のため、ワインデータが重複する可能性
2. **クイズ**: 復習機能がUIレベルで未実装
3. **UX**: エラーメッセージが日本語と英語で混在
4. **パフォーマンス**: 大量データ時の表示速度未検証

## 変更履歴

### 現行バージョン（2025年1月時点）
- 基本的なワイン記録機能
- Google認証とゲストモード
- 部分的なクイズシステム
- 統計表示機能