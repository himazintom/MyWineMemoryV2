#!/bin/sh
# Git pre-commit hook example
# To activate: cp .githooks/pre-commit.example .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "ğŸ” Running pre-commit checks..."

# Check for environment variables in staged files
if git diff --cached --name-only | grep -E '\.(js|ts|tsx)$' | xargs grep -l "VITE_" | grep -v "\.example\|\.test\|\.spec" | head -1; then
    echo "âš ï¸  Environment variables detected in staged files"
    echo "ğŸ”’ Validating environment variables..."
    
    # Run environment validation
    npm run validate:env
    if [ $? -ne 0 ]; then
        echo "âŒ Environment validation failed"
        echo "ğŸ’¡ Fix environment issues before committing"
        exit 1
    fi
fi

# Check for common secret patterns
echo "ğŸ”’ Checking for potential secrets..."
if git diff --cached --name-only | xargs grep -l -E "(password|secret|key|token).*[:=].*['\"][^'\"]{10,}" 2>/dev/null; then
    echo "âŒ Potential secrets detected in staged files"
    echo "ğŸš¨ Review and remove any hardcoded secrets"
    exit 1
fi

# Run linting
echo "ğŸ§¹ Running linter..."
npm run lint
if [ $? -ne 0 ]; then
    echo "âŒ Linting failed"
    echo "ğŸ’¡ Fix linting issues before committing"
    exit 1
fi

# Run tests
echo "ğŸ§ª Running tests..."
npm test
if [ $? -ne 0 ]; then
    echo "âŒ Tests failed"
    echo "ğŸ’¡ Fix failing tests before committing"
    exit 1
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸš€ Ready to commit"